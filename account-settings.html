<script type="module" src="auth.js"></script>
  <script type="module">
    // Safe year setting
    try {
      const yearEl = document.getElementById('year');
      if (yearEl) {
        yearEl.textContent = new Date().getFullYear();
      }
    } catch(e) {
      console.log('Year element not ready yet');
    }
    
    // Import Firebase functions (NO Storage needed)
    import { getAuth, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';

    let currentUser = null;
    let selectedFile = null;

    // Check if user is logged in
    window.addEventListener('load', () => {
      const auth = getAuth();
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          loadUserProfile(user);
        } else {
          window.location.href = 'login.html';
        }
      });
    });

    function loadUserProfile(user) {
      const emailDisplay = document.getElementById('user-email-display');
      const currentProfilePic = document.getElementById('current-profile-pic');
      
      if (emailDisplay) {
        emailDisplay.textContent = user.email;
      }
      
      if (currentProfilePic) {
        if (user.photoURL) {
          currentProfilePic.src = user.photoURL;
        } else {
          // Default avatar with user's initial
          const initial = user.email.charAt(0).toUpperCase();
          currentProfilePic.src = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><circle cx='60' cy='60' r='60' fill='%23008e45'/><text x='60' y='75' text-anchor='middle' fill='white' font-size='48' font-family='Arial'>${initial}</text></svg>`;
        }
      }
    }

    // File input handling
    const profilePicInput = document.getElementById('profile-pic-input');
    if (profilePicInput) {
      profilePicInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
          // Validate file size (1MB max to avoid URL length issues)
          if (file.size > 1 * 1024 * 1024) {
            showError('File size must be less than 1MB to avoid upload errors');
            return;
          }

          // Validate file type
          if (!file.type.startsWith('image/')) {
            showError('Please select a valid image file');
            return;
          }

          selectedFile = file;
          showPreview(file);
        }
      });
    }

    function showPreview(file) {
      const previewContainer = document.getElementById('preview-container');
      const previewImage = document.getElementById('preview-image');
      
      if (previewContainer && previewImage) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }

    // SIMPLE: Save picture with image compression to avoid URL length error
    const savePictureBtn = document.getElementById('save-picture');
    if (savePictureBtn) {
      savePictureBtn.addEventListener('click', async function() {
        if (!selectedFile || !currentUser) return;

        try {
          this.textContent = '‚è≥ Uploading...';
          this.disabled = true;

          console.log('Compressing and uploading image...');
          
          // Create a canvas to resize/compress the image
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          
          img.onload = async function() {
            // Calculate new dimensions (max 200x200 to keep file small)
            let { width, height } = img;
            const maxSize = 200;
            
            if (width > height) {
              if (width > maxSize) {
                height = (height * maxSize) / width;
                width = maxSize;
              }
            } else {
              if (height > maxSize) {
                width = (width * maxSize) / height;
                height = maxSize;
              }
            }
            
            // Set canvas size and draw compressed image
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            // Convert to base64 with compression (0.7 quality)
            const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
            
            console.log('Original size:', selectedFile.size, 'bytes');
            console.log('Compressed base64 length:', compressedBase64.length, 'characters');
            
            try {
              // Update user's Firebase profile with compressed image
              await updateProfile(currentUser, {
                photoURL: compressedBase64
              });
              
              console.log('Profile updated successfully');
              
              // Update the displayed image
              const currentProfilePic = document.getElementById('current-profile-pic');
              if (currentProfilePic) {
                currentProfilePic.src = compressedBase64;
              }
              
              // Hide preview and show success
              const previewContainer = document.getElementById('preview-container');
              if (previewContainer) {
                previewContainer.style.display = 'none';
              }
              
              showSuccess('‚úÖ Profile picture updated! (Device only - no cross-device sync)');
              
              // Reset file input
              const profilePicInput = document.getElementById('profile-pic-input');
              if (profilePicInput) {
                profilePicInput.value = '';
              }
              selectedFile = null;

            } catch (error) {
              console.error('Error updating profile:', error);
              if (error.message.includes('too long')) {
                showError('‚ùå Image still too large. Try a smaller image or lower quality.');
              } else {
                showError(`‚ùå Upload failed: ${error.message}`);
              }
            }
          };
          
          // Load the selected file into the image
          const reader = new FileReader();
          reader.onload = function(e) {
            img.src = e.target.result;
          };
          reader.readAsDataURL(selectedFile);

        } catch (error) {
          console.error('Error processing picture:', error);
          showError('‚ùå Error processing picture. Please try again.');
        } finally {
          this.textContent = 'üíæ Save Picture';
          this.disabled = false;
        }
      });
    }

    // Cancel upload
    const cancelUploadBtn = document.getElementById('cancel-upload');
    if (cancelUploadBtn) {
      cancelUploadBtn.addEventListener('click', function() {
        const previewContainer = document.getElementById('preview-container');
        const profilePicInput = document.getElementById('profile-pic-input');
        
        if (previewContainer) {
          previewContainer.style.display = 'none';
        }
        if (profilePicInput) {
          profilePicInput.value = '';
        }
        selectedFile = null;
      });
    }

    // Logout functionality
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async function(e) {
        e.preventDefault();
        try {
          if (typeof smartAuth !== 'undefined') {
            await smartAuth.signOut();
            window.location.href = 'index.html';
          }
        } catch (err) {
          console.error('Logout error:', err);
        }
      });
    }

    // Password change form handling
    const passwordForm = document.getElementById('password-form');
    if (passwordForm) {
      passwordForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;
        
        // Clear previous messages
        const passwordSuccess = document.getElementById('password-success');
        const passwordError = document.getElementById('password-error');
        
        if (passwordSuccess) passwordSuccess.style.display = 'none';
        if (passwordError) passwordError.style.display = 'none';
        
        // Validate passwords match
        if (newPassword !== confirmPassword) {
          showPasswordError('New passwords do not match');
          return;
        }
        
        // Validate password length
        if (newPassword.length < 6) {
          showPasswordError('New password must be at least 6 characters long');
          return;
        }
        
        try {
          // Change button text to show loading
          const submitBtn = this.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.textContent = '‚è≥ Changing Password...';
            submitBtn.disabled = true;
          }
          
          // Import Firebase auth functions
          const { EmailAuthProvider, reauthenticateWithCredential, updatePassword } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
          
          if (!currentUser) {
            throw new Error('No user logged in');
          }
          
          // Re-authenticate user with current password
          const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
          await reauthenticateWithCredential(currentUser, credential);
          
          // Update password
          await updatePassword(currentUser, newPassword);
          
          // Success
          showPasswordSuccess('Password changed successfully!');
          
          // Clear form
          this.reset();
          
        } catch (error) {
          console.error('Password change error:', error);
          
          if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
            showPasswordError('Current password is incorrect');
          } else if (error.code === 'auth/weak-password') {
            showPasswordError('New password is too weak');
          } else if (error.code === 'auth/requires-recent-login') {
            showPasswordError('Please log out and log back in before changing your password');
          } else if (error.code === 'auth/too-many-requests') {
            showPasswordError('Too many failed attempts. Please try again later');
          } else {
            showPasswordError(`Error: ${error.message || 'Please try again'}`);
          }
        } finally {
          // Reset button
          const submitBtn = this.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.textContent = 'üîê Change Password';
            submitBtn.disabled = false;
          }
        }
      });
    }

    function showPasswordSuccess(message) {
      const successEl = document.getElementById('password-success');
      const errorEl = document.getElementById('password-error');
      
      if (errorEl) errorEl.style.display = 'none';
      if (successEl) {
        successEl.textContent = message;
        successEl.style.display = 'block';
        
        setTimeout(() => {
          successEl.style.display = 'none';
        }, 4000);
      }
    }

    function showPasswordError(message) {
      const successEl = document.getElementById('password-success');
      const errorEl = document.getElementById('password-error');
      
      if (successEl) successEl.style.display = 'none';
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 4000);
      }
    }

    function showSuccess(message) {
      const successEl = document.getElementById('success-message');
      const errorEl = document.getElementById('error-message');
      
      if (errorEl) errorEl.style.display = 'none';
      if (successEl) {
        successEl.textContent = message;
        successEl.style.display = 'block';
        
        setTimeout(() => {
          successEl.style.display = 'none';
        }, 4000);
      }
    }

    function showError(message) {
      const successEl = document.getElementById('success-message');
      const errorEl = document.getElementById('error-message');
      
      if (successEl) successEl.style.display = 'none';
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 4000);
      }
    }

    console.log('Account settings loaded - simple profile upload mode');
  </script>
