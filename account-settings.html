<script type="module" src="auth.js"></script>
  <script type="module">
    document.getElementById('year').textContent = new Date().getFullYear();
    
    // Import Firebase functions (ADDED Storage)
    import { getAuth, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js';

    let currentUser = null;
    let selectedFile = null;

    // Check if user is logged in
    window.addEventListener('load', () => {
      const auth = getAuth();
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          loadUserProfile(user);
        } else {
          // Redirect to login if not authenticated
          window.location.href = 'login.html';
        }
      });
    });

    function loadUserProfile(user) {
      const emailDisplay = document.getElementById('user-email-display');
      const currentProfilePic = document.getElementById('current-profile-pic');
      
      emailDisplay.textContent = user.email;
      
      // Check if user has a profile picture URL in Firebase
      if (user.photoURL) {
        currentProfilePic.src = user.photoURL;
      } else {
        // Default avatar with user's initial
        const initial = user.email.charAt(0).toUpperCase();
        currentProfilePic.src = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><circle cx='60' cy='60' r='60' fill='%23008e45'/><text x='60' y='75' text-anchor='middle' fill='white' font-size='48' font-family='Arial'>${initial}</text></svg>`;
      }
    }

    // File input handling
    document.getElementById('profile-pic-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          showError('File size must be less than 5MB');
          return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
          showError('Please select a valid image file');
          return;
        }

        selectedFile = file;
        showPreview(file);
      }
    });

    function showPreview(file) {
      const previewContainer = document.getElementById('preview-container');
      const previewImage = document.getElementById('preview-image');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    // FIXED: Save picture using Firebase Storage instead of base64
    document.getElementById('save-picture').addEventListener('click', async function() {
      if (!selectedFile || !currentUser) return;

      try {
        this.textContent = '‚è≥ Uploading...';
        this.disabled = true;

        console.log('Uploading to Firebase Storage...');
        
        // Get Firebase Storage reference
        const storage = getStorage();
        
        // Create a unique filename using user ID and timestamp
        const fileName = `profile-pictures/${currentUser.uid}_${Date.now()}.${selectedFile.name.split('.').pop()}`;
        const storageRef = ref(storage, fileName);
        
        // Upload file to Firebase Storage
        const snapshot = await uploadBytes(storageRef, selectedFile);
        console.log('File uploaded successfully');
        
        // Get the download URL
        const downloadURL = await getDownloadURL(snapshot.ref);
        console.log('Download URL obtained:', downloadURL);
        
        // Update user's Firebase profile with the download URL
        await updateProfile(currentUser, {
          photoURL: downloadURL
        });
        
        console.log('Profile updated successfully');
        
        // Update the displayed image
        document.getElementById('current-profile-pic').src = downloadURL;
        
        // Hide preview and show success
        document.getElementById('preview-container').style.display = 'none';
        showSuccess('Profile picture updated successfully!');
        
        // Reset file input
        document.getElementById('profile-pic-input').value = '';
        selectedFile = null;

      } catch (error) {
        console.error('Error updating profile:', error);
        showError(`Error updating profile: ${error.message}`);
      } finally {
        this.textContent = 'üíæ Save Picture';
        this.disabled = false;
      }
    });

    // Cancel upload
    document.getElementById('cancel-upload').addEventListener('click', function() {
      document.getElementById('preview-container').style.display = 'none';
      document.getElementById('profile-pic-input').value = '';
      selectedFile = null;
    });

    // Logout functionality
    document.getElementById('logout-btn').addEventListener('click', async function(e) {
      e.preventDefault();
      try {
        if (typeof smartAuth !== 'undefined') {
          await smartAuth.signOut();
          window.location.href = 'index.html';
        }
      } catch (err) {
        console.error('Logout error:', err);
      }
    });

    // Password change form handling
    document.getElementById('password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      // Clear previous messages
      document.getElementById('password-success').style.display = 'none';
      document.getElementById('password-error').style.display = 'none';
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        showPasswordError('New passwords do not match');
        return;
      }
      
      // Validate password length
      if (newPassword.length < 6) {
        showPasswordError('New password must be at least 6 characters long');
        return;
      }
      
      try {
        // Change button text to show loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '‚è≥ Changing Password...';
        submitBtn.disabled = true;
        
        // Import Firebase auth functions
        const { EmailAuthProvider, reauthenticateWithCredential, updatePassword } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
        
        if (!currentUser) {
          throw new Error('No user logged in');
        }
        
        // Re-authenticate user with current password
        const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
        await reauthenticateWithCredential(currentUser, credential);
        
        // Update password
        await updatePassword(currentUser, newPassword);
        
        // Success
        showPasswordSuccess('Password changed successfully!');
        
        // Clear form
        this.reset();
        
      } catch (error) {
        console.error('Password change error:', error);
        console.log('Error code:', error.code); // Debug log
        
        if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          showPasswordError('Current password is incorrect');
        } else if (error.code === 'auth/weak-password') {
          showPasswordError('New password is too weak');
        } else if (error.code === 'auth/requires-recent-login') {
          showPasswordError('Please log out and log back in before changing your password');
        } else if (error.code === 'auth/too-many-requests') {
          showPasswordError('Too many failed attempts. Please try again later');
        } else {
          showPasswordError(`Error: ${error.message || 'Please try again'}`);
        }
      } finally {
        // Reset button
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.textContent = 'üîê Change Password';
        submitBtn.disabled = false;
      }
    });

    function showPasswordSuccess(message) {
      const successEl = document.getElementById('password-success');
      const errorEl = document.getElementById('password-error');
      
      errorEl.style.display = 'none';
      successEl.textContent = message;
      successEl.style.display = 'block';
      
      setTimeout(() => {
        successEl.style.display = 'none';
      }, 4000);
    }

    function showPasswordError(message) {
      const successEl = document.getElementById('password-success');
      const errorEl = document.getElementById('password-error');
      
      successEl.style.display = 'none';
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 4000);
    }

    function showSuccess(message) {
      const successEl = document.getElementById('success-message');
      const errorEl = document.getElementById('error-message');
      
      errorEl.style.display = 'none';
      successEl.textContent = message;
      successEl.style.display = 'block';
      
      setTimeout(() => {
        successEl.style.display = 'none';
      }, 4000);
    }

    function showError(message) {
      const successEl = document.getElementById('success-message');
      const errorEl = document.getElementById('error-message');
      
      successEl.style.display = 'none';
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 4000);
    }
  </script>
