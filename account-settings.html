<script type="module" src="auth.js"></script>
  <script type="module">
    const yearEl = document.getElementById('year');
    if (yearEl) yearEl.textContent = new Date().getFullYear();
    
    // Import Firebase functions (ADDED Storage for cross-device sync)
    import { getAuth, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js';

    let currentUser = null;
    let selectedFile = null;

    // Check if user is logged in
    window.addEventListener('load', () => {
      const auth = getAuth();
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          loadUserProfile(user);
        } else {
          // Redirect to login if not authenticated
          window.location.href = 'login.html';
        }
      });
    });

    function loadUserProfile(user) {
      const emailDisplay = document.getElementById('user-email-display');
      const currentProfilePic = document.getElementById('current-profile-pic');
      
      emailDisplay.textContent = user.email;
      
      // Check if user has a profile picture URL in Firebase
      if (user.photoURL && !user.photoURL.startsWith('data:')) {
        // It's a Firebase Storage URL - will sync across devices
        currentProfilePic.src = user.photoURL;
      } else if (user.photoURL && user.photoURL.startsWith('data:')) {
        // It's an old base64 image - still show it but suggest re-upload
        currentProfilePic.src = user.photoURL;
        showInfo('ðŸ’¡ Tip: Re-upload your profile picture to sync it across all your devices!');
      } else {
        // Default avatar with user's initial
        const initial = user.email.charAt(0).toUpperCase();
        currentProfilePic.src = `data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><circle cx='60' cy='60' r='60' fill='%23008e45'/><text x='60' y='75' text-anchor='middle' fill='white' font-size='48' font-family='Arial'>${initial}</text></svg>`;
      }
    }

    // File input handling
    document.getElementById('profile-pic-input').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          showError('File size must be less than 5MB');
          return;
        }

        // Validate file type
        if (!file.type.startsWith('image/')) {
          showError('Please select a valid image file');
          return;
        }

        selectedFile = file;
        showPreview(file);
      }
    });

    function showPreview(file) {
      const previewContainer = document.getElementById('preview-container');
      const previewImage = document.getElementById('preview-image');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImage.src = e.target.result;
        previewContainer.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }

    // UPDATED: Save picture using Firebase Storage for cross-device sync
    document.getElementById('save-picture').addEventListener('click', async function() {
      if (!selectedFile || !currentUser) return;

      try {
        this.textContent = 'â³ Uploading...';
        this.disabled = true;

        console.log('Uploading to Firebase Storage for cross-device sync...');
        
        // Get Firebase Storage reference
        const storage = getStorage();
        
        // Create a unique filename using user ID
        const fileExtension = selectedFile.name.split('.').pop().toLowerCase();
        const fileName = `profile-pictures/${currentUser.uid}.${fileExtension}`;
        const storageRef = ref(storage, fileName);
        
        // If user already has a Storage-based profile picture, delete the old one first
        if (currentUser.photoURL && currentUser.photoURL.includes('firebase')) {
          try {
            const oldRef = ref(storage, `profile-pictures/${currentUser.uid}.jpg`);
            await deleteObject(oldRef).catch(() => {}); // Ignore errors if file doesn't exist
            const oldRef2 = ref(storage, `profile-pictures/${currentUser.uid}.png`);
            await deleteObject(oldRef2).catch(() => {}); // Ignore errors if file doesn't exist
            const oldRef3 = ref(storage, `profile-pictures/${currentUser.uid}.jpeg`);
            await deleteObject(oldRef3).catch(() => {}); // Ignore errors if file doesn't exist
          } catch (e) {
            console.log('Note: Could not delete old profile picture');
          }
        }
        
        // Upload file to Firebase Storage
        const snapshot = await uploadBytes(storageRef, selectedFile);
        console.log('File uploaded successfully to Storage');
        
        // Get the download URL
        const downloadURL = await getDownloadURL(snapshot.ref);
        console.log('Download URL obtained:', downloadURL);
        
        // Update user's Firebase profile with the Storage URL
        await updateProfile(currentUser, {
          photoURL: downloadURL
        });
        
        console.log('Profile updated successfully - will sync across all devices!');
        
        // Update the displayed image
        document.getElementById('current-profile-pic').src = downloadURL;
        
        // Hide preview and show success
        document.getElementById('preview-container').style.display = 'none';
        showSuccess('âœ… Profile picture uploaded! It will now sync across all your devices.');
        
        // Reset file input
        document.getElementById('profile-pic-input').value = '';
        selectedFile = null;

      } catch (error) {
        console.error('Error updating profile:', error);
        
        if (error.code === 'storage/unauthorized') {
          showError('Permission denied. Please check Firebase Storage rules.');
        } else if (error.code === 'storage/quota-exceeded') {
          showError('Storage quota exceeded. Please contact support.');
        } else if (error.code === 'storage/retry-limit-exceeded') {
          showError('Upload failed. Please check your connection and try again.');
        } else {
          showError(`Upload failed: ${error.message}`);
        }
      } finally {
        this.textContent = 'ðŸ’¾ Save Picture';
        this.disabled = false;
      }
    });

    // Cancel upload
    document.getElementById('cancel-upload').addEventListener('click', function() {
      document.getElementById('preview-container').style.display = 'none';
      document.getElementById('profile-pic-input').value = '';
      selectedFile = null;
    });

    // Logout functionality
    document.getElementById('logout-btn').addEventListener('click', async function(e) {
      e.preventDefault();
      try {
        if (typeof smartAuth !== 'undefined') {
          await smartAuth.signOut();
          window.location.href = 'index.html';
        }
      } catch (err) {
        console.error('Logout error:', err);
      }
    });

    // Password change form handling
    document.getElementById('password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;
      
      // Clear previous messages
      document.getElementById('password-success').style.display = 'none';
      document.getElementById('password-error').style.display = 'none';
      
      // Validate passwords match
      if (newPassword !== confirmPassword) {
        showPasswordError('New passwords do not match');
        return;
      }
      
      // Validate password length
      if (newPassword.length < 6) {
        showPasswordError('New password must be at least 6 characters long');
        return;
      }
      
      try {
        // Change button text to show loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'â³ Changing Password...';
        submitBtn.disabled = true;
        
        // Import Firebase auth functions
        const { EmailAuthProvider, reauthenticateWithCredential, updatePassword } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
        
        if (!currentUser) {
          throw new Error('No user logged in');
        }
        
        // Re-authenticate user with current password
        const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
        await reauthenticateWithCredential(currentUser, credential);
        
        // Update password
        await updatePassword(currentUser, newPassword);
        
        // Success
        showPasswordSuccess('Password changed successfully!');
        
        // Clear form
        this.reset();
        
      } catch (error) {
        console.error('Password change error:', error);
        console.log('Error code:', error.code); // Debug log
        
        if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
          showPasswordError('Current password is incorrect');
        } else if (error.code === 'auth/weak-password') {
          showPasswordError('New password is too weak');
        } else if (error.code === 'auth/requires-recent-login') {
          showPasswordError('Please log out and log back in before changing your password');
        } else if (error.code === 'auth/too-many-requests') {
          showPasswordError('Too many failed attempts. Please try again later');
        } else {
          showPasswordError(`Error: ${error.message || 'Please try again'}`);
        }
      } finally {
        // Reset button
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.textContent = 'ðŸ” Change Password';
        submitBtn.disabled = false;
      }
    });

    function showPasswordSuccess(message) {
      const successEl = document.getElementById('password-success');
      const errorEl = document.getElementById('password-error');
      
      errorEl.style.display = 'none';
      successEl.textContent = message;
      successEl.style.display = 'block';
      
      setTimeout(() => {
        successEl.style.display = 'none';
      }, 4000);
    }

    function showPasswordError(message) {
      const successEl = document.getElementById('password-success');
      const errorEl = document.getElementById('password-error');
      
      successEl.style.display = 'none';
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 4000);
    }

    function showSuccess(message) {
      const successEl = document.getElementById('success-message');
      const errorEl = document.getElementById('error-message');
      
      errorEl.style.display = 'none';
      successEl.textContent = message;
      successEl.style.display = 'block';
      
      setTimeout(() => {
        successEl.style.display = 'none';
      }, 4000);
    }

    function showError(message) {
      const successEl = document.getElementById('success-message');
      const errorEl = document.getElementById('error-message');
      
      successEl.style.display = 'none';
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      
      setTimeout(() => {
        errorEl.style.display = 'none';
      }, 4000);
    }

    function showInfo(message) {
      const infoEl = document.createElement('div');
      infoEl.style.cssText = `
        background: #e3f2fd;
        color: #1565c0;
        border: 1px solid #bbdefb;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        text-align: center;
        font-size: 0.9rem;
      `;
      infoEl.textContent = message;
      
      const profileSection = document.querySelector('.profile-section');
      profileSection.appendChild(infoEl);
      
      setTimeout(() => {
        if (infoEl.parentNode) {
          infoEl.parentNode.removeChild(infoEl);
        }
      }, 8000);
    }
  </script>

